â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ›   ë¼í”Œ ì‘ì—…ì§€ì‹œì„œ  
í”„ë¡œì íŠ¸: ì°½ì¡°AI â€“ Dream Book ì´ë¯¸ì§€ ì¼ê´€ì„± ê³ ë„í™”  
ì‘ì„±ì¼: 2025-05-23  
ì§€ì‹œ ë°©ì‹: â€œ1ë²ˆë¶€í„° ìˆœì„œëŒ€ë¡œâ€ ì™„ë£Œ í›„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ¯ ëª©í‘œ
1. ìºë¦­í„° ì–¼êµ´Â·í¬ì¦ˆ **ì¼ê´€ì„±** ìœ ì§€  
2. ë°°ê²½Â·ìƒ‰ê°Â·í™”í’ **ì¼ê´€ì„±** í™•ë³´  
3. ëª¨ë“  í”„ë¡¬í”„íŠ¸ ê·œì¹™ì„ **ê´€ë¦¬ì UI**ë¡œ í†µì œ (í•˜ë“œì½”ë”© ê¸ˆì§€)  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‚ ì˜í–¥ ë²”ìœ„
â€¢ DB: `style_templates`, `global_prompt_rules` (ì‹ ê·œ)  
â€¢ Backend: `server/services/dream-image.ts`, `shared/prompt-utils.ts`, `shared/seed.ts`  
â€¢ Admin UI:  
  - `pages/admin/Styles.tsx` (ê¸°ì¡´)  
  - `pages/admin/GlobalRules.tsx` (ì‹ ê·œ)  
â€¢ Frontend:  
  - `client/src/pages/dream-book/create.tsx` (í¼)  
  - `client/src/pages/dream-book/result.tsx` (ë·°ì–´)  
â€¢ Tests: `tests/dream-consistency.spec.ts`

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¢ ìƒì„¸ ì‘ì—… ìˆœì„œ
1. **DB ë§ˆì´ê·¸ë ˆì´ì…˜**  
   1-1) `style_templates` í…Œì´ë¸”  
        (id PK, name, prompt, thumbnail_url, is_default boolean)  
   1-2) `global_prompt_rules` í…Œì´ë¸”  
        (id PK, name, json_rules jsonb, is_active boolean)  

2. **Seed ìŠ¤í¬ë¦½íŠ¸**  
   â€¢ ê¸°ë³¸ ìŠ¤íƒ€ì¼ 1ê±´, ê¸°ë³¸ ì „ì—­ ê·œì¹™ 1ê±´(`is_active = true`) ì‚½ì…  
   â€¢ ê·œì¹™ ì˜ˆì‹œ  
     ```json
     {
       "ratio": "1:1",
       "subject": "pregnant Korean woman in her 20s"
     }
     ```  

3. **shared/prompt-utils.ts**  
   â€¢ `getActivePromptRules()` â€“ ì „ì—­ ê·œì¹™ JSON ë°˜í™˜  
   â€¢ `composePrompt(stylePrompt, scenePrompt, characterPrompt, rules)` í—¬í¼  

4. **Admin UI â€“ Styles**  
   â€¢ ì¸ë„¤ì¼ ëª©ë¡ + ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ/ê¸°ë³¸ì§€ì •  

5. **Admin UI â€“ GlobalRules**  
   â€¢ ê·œì¹™ ëª©ë¡, JSON í¸ì§‘, í™œì„±í™” í† ê¸€(í•­ìƒ 1ê°œë§Œ í™œì„±í™”)  
   â€¢ JSON ì…ë ¥ í—¬í¼(í‚¤: ratio/subject/extra ë“± ììœ  í™•ì¥)  

6. **client/src/pages/dream-book/create.tsx**  
   â€¢ ìŠ¤íƒ€ì¼ ë“œë¡­ë‹¤ìš´(ê¸°ë³¸ê°’ is_default) â†’ `style_id` í¬í•¨ FormData ì „ì†¡  

7. **server/services/dream-image.ts** (ì „ë©´ ë¦¬íŒ©í† ë§)  
   7-1) `style_id`ë¡œ ìŠ¤íƒ€ì¼ í”„ë¡¬í”„íŠ¸ ë¡œë“œ  
   7-2) `getActivePromptRules()` í˜¸ì¶œ í›„ rules JSONì„ í”„ë¡¬í”„íŠ¸ ê°€ì¥ ì•ì— ì‚½ì…  
   7-3) ìºë¦­í„° ì°¸ì¡° ì´ë¯¸ì§€ â†’ IDAdapter ì„¸ì…˜ ì—…ë¡œë“œ  
   7-4) **seed ì „ëµ**  
        - scene0: ëœë¤ seed ìƒì„±, Redis ìºì‹œ `dream:{jobId}:seed` ì €ì¥  
        - scene1-4: ë™ì¼ seed ì‚¬ìš©  
   7-5) GPT-Vision(gpt-4o) â†’ ì•ˆì „ í•„í„°Â·ìš”ì•½  
   7-6) GPT-Image-1 í˜¸ì¶œ íŒŒë¼ë¯¸í„°  
        ```ts
        {
          prompt: composedPrompt,
          reference_image_url: charRef,
          ratio: "1:1",
          seed
        }
        ```  

8. **client/src/pages/dream-book/result.tsx**  
   â€¢ ë°°ê²½ ìŠ¤íƒ€ì¼ íƒœê·¸ í‘œì‹œ, ì¹´ë“œ/ìŠ¬ë¼ì´ë“œ ì„ íƒ í† ê¸€  
   â€¢ ì´ë¯¸ì§€ ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ ì¶”ê°€ (Shimmer)  

9. **shared/seed.ts** â€“ seed ìƒì„±Â·ì €ì¥Â·ë¶ˆëŸ¬ì˜¤ê¸° ìœ í‹¸ ì¶”ê°€  

10. **E2E í…ŒìŠ¤íŠ¸** (`dream-consistency.spec.ts`)  
    â€¢ ë™ì¼ ì…ë ¥ 5íšŒ ë°˜ë³µ â†’ ì–¼êµ´ ìœ ì‚¬ë„ â‰¥ 96%, ë°°ê²½ ìƒ‰ìƒ í¸ì°¨ â‰¤ 5% ê²€ì‚¬  
    â€¢ ì „ì—­ ê·œì¹™ ON/OFF í›„ ratio ë³€í™” ê²€ì¦  

11. **í™˜ê²½ë³€ìˆ˜ ë°±ì—… ì˜µì…˜**  
    â€¢ `DEFAULT_PROMPT_RULE` (JSON ë¬¸ìì—´) â€“ DBì— í™œì„± ê·œì¹™ ì—†ì„ ë•Œë§Œ ì‚¬ìš©  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… Definition of Done
â€¢ ì „ì—­ ê·œì¹™Â·ìŠ¤íƒ€ì¼ ëª¨ë‘ ê´€ë¦¬ì UIì—ì„œ CRUD/í™œì„±í™” ê°€ëŠ¥  
â€¢ í•˜ë“œì½”ë”©ëœ ratio/subject ë¬¸ìì—´ **ì—†ìŒ**  
â€¢ ê°™ì€ ì…ë ¥ìœ¼ë¡œ 5ì»· ìƒì„± ì‹œ ìºë¦­í„°Â·ë°°ê²½ ì¼ê´€ì„± ê¸°ì¤€ ì¶©ì¡±  
â€¢ seed ìºì‹±ìœ¼ë¡œ ì¬ì‹œë„ ê°„ ê²°ê³¼ ë™ì¼  
â€¢ ëª¨ë“  E2E í…ŒìŠ¤íŠ¸ í†µê³¼, PR ë¦¬ë·°Â·ë¨¸ì§€ í›„ main ë°°í¬  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
