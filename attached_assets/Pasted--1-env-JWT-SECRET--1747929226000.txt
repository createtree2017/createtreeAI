✅ [🔥 라플이 작업지시서: 인증 시스템 최종 점검 및 완전 수리 지시서]
📌 1. .env 파일 설정
❌ 현재 상태:
JWT_SECRET이 없음 → 서버가 각 파일마다 임의의 기본값을 사용하여 JWT를 생성/검증함 → 인증 실패 발생

✅ 지시:
.env 파일에 다음을 반드시 추가:

env
복사
편집
JWT_SECRET=super-secret-key-2024
🚨 이 값은 .env, Firebase 로그인 처리, 일반 로그인 토큰 생성, jwt-auth.ts 등 모든 위치에서 동일하게 사용되어야 함
❗ Replit Secrets에도 같은 이름(JWT_SECRET)으로 등록되어야 함

📌 2. 서버 진입점 index.ts 파일 점검 및 수정
✅ 지시:
(1) 맨 위에 환경변수 불러오는 코드 포함

ts
복사
편집
import dotenv from 'dotenv';
dotenv.config();
(2) Express 에러 핸들러 추가 – HTML이 아닌 JSON으로 반환할 것

ts
복사
편집
// 500 오류를 항상 JSON으로 반환
app.use((err, req, res, next) => {
  console.error('[Express 에러]', err.stack);
  res.status(err.status || 500).json({
    success: false,
    message: err.message || '서버 오류 발생'
  });
});
(3) 404 (Not Found) 요청도 JSON 반환 설정

ts
복사
편집
app.use((req, res) => {
  res.status(404).json({
    success: false,
    message: '요청한 경로를 찾을 수 없습니다'
  });
});
📌 3. /api/auth/me 및 /api/jwt-auth/verify-token 서버 라우터 점검
✅ 지시:
(1) 모든 응답은 반드시 res.json() 형태로 반환할 것

절대 res.send(...), res.sendFile(...), next() 호출 후 방치하지 말 것

(2) JWT 토큰 검증 실패 시 다음처럼 JSON 응답

ts
복사
편집
return res.status(401).json({
  success: false,
  message: 'Unauthorized - JWT 토큰 검증 실패',
});
📌 4. JWT 검증 라이브러리 사용하는 모든 서버 파일 점검
다음 파일들을 모두 점검하고 동일한 process.env.JWT_SECRET을 사용 중인지 확인

bash
복사
편집
server/routes/auth.ts
server/routes/jwt-auth.ts
server/routes/google-oauth.ts
server/services/auth.ts
✅ 지시:
모든 JWT 관련 코드에 다음과 같이 비밀키 사용:

ts
복사
편집
const JWT_SECRET = process.env.JWT_SECRET!;
const decoded = jwt.verify(token, JWT_SECRET);
📌 5. 클라이언트 (useAuth.ts) 점검
✅ 지시:
/api/auth/me 요청 시 JWT 토큰이 있을 경우 Authorization 헤더로 다음과 같이 추가해야 함:

ts
복사
편집
const jwtToken = localStorage.getItem('auth_token');
const headers = {};
if (jwtToken) {
  headers["Authorization"] = `Bearer ${jwtToken}`;
}
JWT 검증 실패 시 서버가 HTML을 반환하면 JSON 파싱 실패 발생 → 지금 이 문제를 고치고 있는 것임

📌 6. 서버 재시작 반드시 수행
✅ 지시:
.env 파일 수정 후, 서버를 반드시 완전히 재시작할 것 (환경 변수 적용 필요)

🧠 기대 결과
항목	기대 결과
로그인 후 /api/auth/me 요청	✅ JSON 응답, 200 OK
JWT 실패 시	✅ JSON 응답 + status 401
로그인 상태 유지	✅ setUser(user) + 캐시 반영 성공
Console 오류	✅ SyntaxError: Unexpected token '<' 사라짐

✅ 라플이에게 강조
javascript
복사
편집
이 작업은 단순 UI 문제가 아니라,
JWT 인증 시스템의 근본적 안정성과 사용자 로그인 기능 전반이 걸린 핵심 수정입니다.

반드시 하나도 빠짐없이 적용하고,
수정 후 `/api/auth/me` 응답이 HTML이 아닌 JSON으로 나오는지 확인해주세요.