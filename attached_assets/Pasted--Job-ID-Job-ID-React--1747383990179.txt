ìŒì•… ìƒì„± ìš”ì²­ â†’ ì¦‰ì‹œ Job ID ë°˜í™˜ â†’ í´ë¼ì´ì–¸íŠ¸ëŠ” Job IDë§Œ ê°€ì§€ê³  ì „ì—­ í´ë§ â†’ ì–¸ì œë“  ìƒíƒœ ì¡°íšŒ

ì…ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ í˜ì´ì§€ ì „í™˜Â·íƒ­ ì´ë™Â·ë¦¬ë¡œë”© ë“± React ì»´í¬ë„ŒíŠ¸ ë¼ì´í”„ì‚¬ì´í´ê³¼ ì™„ì „íˆ ë¶„ë¦¬ë˜ì–´, â€œë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ë„˜ì–´ê°€ë„ ë©ˆì¶”ê±°ë‚˜ ì´ˆê¸°í™”ë˜ì§€ ì•ŠëŠ”â€ êµ¬ì¡°ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

1. ì„œë²„: Job ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬
Job í ì—”íì™€ ìƒíƒœ ì¡°íšŒ API

POST /api/music â†’ íŒŒë¼ë¯¸í„° ë°›ê³ , ë‚´ë¶€ì—ì„œ ë¹„ë™ê¸°ë¡œ ìŒì•… ìƒì„± ì‘ì—…ì„ í(ë©”ëª¨ë¦¬, Redis, DB ë“±)ì— ë“±ë¡ â†’ ê³§ë°”ë¡œ { jobId } ë°˜í™˜

GET /api/music/:jobId/status â†’ { state: "pending"|"processing"|"done"|"error", resultUrl? } ë°˜í™˜

js
ë³µì‚¬
í¸ì§‘
// server/routes/music.js
import express from "express";
import * as musicQueue from "../services/musicQueue.js";
const router = express.Router();

// 1) ìŒì•… ìƒì„± ìš”ì²­ â†’ jobId ë°˜í™˜
router.post("/", async (req, res, next) => {
  try {
    const jobId = await musicQueue.enqueue(req.body); 
    res.json({ jobId });
  } catch (e) {
    next(e);
  }
});

// 2) job ìƒíƒœ ì¡°íšŒ
router.get("/:jobId/status", async (req, res, next) => {
  try {
    const status = await musicQueue.getStatus(req.params.jobId);
    res.json(status);
  } catch (e) {
    next(e);
  }
});

export default router;
js
ë³µì‚¬
í¸ì§‘
// server/services/musicQueue.js
// ì˜ˆì‹œ: ê°„ë‹¨í•œ ë©”ëª¨ë¦¬ í + Mapìœ¼ë¡œ ìƒíƒœ ê´€ë¦¬
const jobs = new Map();

export async function enqueue(params) {
  const jobId = String(Date.now()) + Math.random();
  jobs.set(jobId, { state: "pending" });
  // ì‹¤ì œ ì‘ì—…ì€ ë¹„ë™ê¸° íƒ€ì´ë¨¸ë‚˜ ë³„ë„ ì›Œì»¤ì—ì„œ ìˆ˜í–‰
  setImmediate(() => processJob(jobId, params));
  return jobId;
}

async function processJob(jobId, { prompt }) {
  jobs.set(jobId, { state: "processing" });
  try {
    // â–¶ï¸ ì—¬ê¸°ì— ì‹¤ì œ ìŒì•… ìƒì„± ë¡œì§ í˜¸ì¶œ (OpenAI ë“±)
    const resultUrl = await generateMusicAndStoreUrl(prompt);
    jobs.set(jobId, { state: "done", resultUrl });
  } catch (err) {
    jobs.set(jobId, { state: "error" });
  }
}

export function getStatus(jobId) {
  return jobs.get(jobId) || { state: "error" };
}
2. í´ë¼ì´ì–¸íŠ¸: ì „ì—­ Context + í´ë§
MusicJobContext ì‘ì„±

jobId, status, resultUrlë¥¼ ì „ì—­ìœ¼ë¡œ ê´€ë¦¬

startJob() í˜¸ì¶œ ì‹œ POST /api/music â†’ jobId ë°›ê³ , ìƒíƒœ "pending" ì„¸íŒ…

useEffect í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” í´ë§ìœ¼ë¡œ GET /api/music/:jobId/status 2ì´ˆë§ˆë‹¤ í˜¸ì¶œ

jsx
ë³µì‚¬
í¸ì§‘
// client/src/lib/MusicJobContext.jsx
import React, { createContext, useContext, useState, useEffect } from "react";
import axios from "axios";

const Ctx = createContext();
export const useMusicJob = () => useContext(Ctx);

export function MusicJobProvider({ children }) {
  const [jobId, setJobId]     = useState(() => localStorage.getItem("musicJobId"));
  const [status, setStatus]   = useState("idle");
  const [resultUrl, setResultUrl] = useState(null);

  // 1) í˜ì´ì§€ ë¡œë“œ ì‹œ, ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë‚¨ì•„ìˆëŠ” jobIdê°€ ìˆìœ¼ë©´ í´ë§ ì‹œì‘
  useEffect(() => {
    if (!jobId) return;
    setStatus("pending");
    const timer = setInterval(async () => {
      try {
        const { data } = await axios.get(`/api/music/${jobId}/status`);
        setStatus(data.state);
        if (data.state === "done") {
          setResultUrl(data.resultUrl);
          clearInterval(timer);
        }
        if (data.state === "error") {
          clearInterval(timer);
        }
      } catch {
        clearInterval(timer);
        setStatus("error");
      }
    }, 2000);
    return () => clearInterval(timer);
  }, [jobId]);

  // 2) ìƒˆë¡œ ì‘ì—… ì‹œì‘
  const startJob = async (params) => {
    const { data } = await axios.post("/api/music", params);
    localStorage.setItem("musicJobId", data.jobId);
    setJobId(data.jobId);
    setResultUrl(null);
    setStatus("pending");
  };

  return (
    <Ctx.Provider value={{ jobId, status, resultUrl, startJob }}>
      {children}
    </Ctx.Provider>
  );
}
App ìµœìƒë‹¨ì— Provider ë˜í•‘

index.js ë˜ëŠ” App.jsx ì— MusicJobProvider ë¥¼ <BrowserRouter>ë³´ë‹¤ ë°”ê¹¥ì— ìœ„ì¹˜ì‹œì¼œì•¼, ì–´ë–¤ í˜ì´ì§€ë¡œ ì´ë™í•´ë„ ì‚´ì•„ë‚¨ìŠµë‹ˆë‹¤.

jsx
ë³µì‚¬
í¸ì§‘
// client/src/index.js
import React from "react";
import ReactDOM from "react-dom";
import App from "./App";
import { MusicJobProvider } from "./lib/MusicJobContext";

ReactDOM.render(
  <MusicJobProvider>
    <App />
  </MusicJobProvider>,
  document.getElementById("root")
);
í—¤ë”ë‚˜ ê³µí†µ ë ˆì´ì•„ì›ƒì— ìƒíƒœ í‘œì‹œê¸° ì¶”ê°€

jsx
ë³µì‚¬
í¸ì§‘
// client/src/components/MusicIndicator.jsx
import React from "react";
import { useMusicJob } from "../lib/MusicJobContext";

export default function MusicIndicator() {
  const { status } = useMusicJob();
  if (status === "idle" || status === "done") return null;
  return <div className="indicator">ğŸµ ìŒì•… ìƒì„± ì¤‘â€¦ ({status})</div>;
}
jsx
ë³µì‚¬
í¸ì§‘
// client/src/App.jsx
import React from "react";
import { BrowserRouter, Routes, Route } from "react-router-dom";
import MusicIndicator from "./components/MusicIndicator";
import MusicPage from "./pages/MusicPage";

export default function App() {
  return (
    <BrowserRouter>
      <MusicIndicator />   {/* í•­ìƒ í™”ë©´ ìƒë‹¨ì— í‘œì‹œ */}
      <Routes>
        <Route path="/music" element={<MusicPage />} />
        {/* ...other routes */}
      </Routes>
    </BrowserRouter>
  );
}
ìŒì•… ìƒì„± í˜ì´ì§€ì—ì„œ Context ì‚¬ìš©

jsx
ë³µì‚¬
í¸ì§‘
// client/src/pages/MusicPage.jsx
import React, { useState } from "react";
import { useMusicJob } from "../lib/MusicJobContext";

export default function MusicPage() {
  const [prompt, setPrompt] = useState("");
  const { status, resultUrl, startJob } = useMusicJob();

  const onSubmit = e => {
    e.preventDefault();
    startJob({ prompt });
  };

  return (
    <form onSubmit={onSubmit}>
      <textarea
        value={prompt}
        onChange={e => setPrompt(e.target.value)}
        placeholder="ìŒì•… ìƒì„± í”„ë¡¬í”„íŠ¸"
      />
      <button disabled={status === "pending" || status === "processing"}>
        ìƒì„± ì‹œì‘
      </button>

      {status === "processing" && <p>ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìƒì„± ì¤‘â€¦</p>}
      {status === "done" && <audio src={resultUrl} controls autoPlay />}
      {status === "error" && <p>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>}
    </form>
  );
}
3. ì²´í¬í¬ì¸íŠ¸ & ë””ë²„ê¹…
Provider ìœ„ì¹˜ í™•ì¸

MusicJobProvider ê°€ ë¼ìš°í„°ë‚˜ í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ë³´ë‹¤ ìœ—ë‹¨ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

useEffect ì˜ ì˜ì¡´ì„± ë°°ì—´

ë¹ˆ ë°°ì—´([])ì´ ì•„ë‹Œ [jobId] ë¡œ ì„¤ì •ë˜ì–´ì•¼, jobIdê°€ ë°”ë€” ë•Œë§ˆë‹¤ ìƒˆ í´ë§ì´ ì‹œì‘ë©ë‹ˆë‹¤.

ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™” ì—¬ë¶€

localStorage.clear() ê°€ ì–´ë””ì„ ê°€ í˜¸ì¶œë˜ê³  ìˆì§€ ì•Šì€ì§€ í™•ì¸

React Router vs Next.js

Next.jsë¥¼ ì“°ì‹ ë‹¤ë©´ _app.js ì— Providerë¥¼ ë˜í•‘í•´ì•¼ í•˜ê³ , <Link> ì»´í¬ë„ŒíŠ¸ë¥¼ ì¨ì•¼ ì „ì²´ í˜ì´ì§€ ë¦¬ë¡œë“œë¥¼ ë§‰ìŠµë‹ˆë‹¤.

Network íƒ­ìœ¼ë¡œ í´ë§ í™•ì¸

íƒ­ ì´ë™ í›„ì—ë„ 2ì´ˆ ì£¼ê¸°ë¡œ /api/music/:jobId/status ìš”ì²­ì´ ë‚˜ê°€ëŠ”ì§€ ë¸Œë¼ìš°ì € DevTools Network íƒ­ì—ì„œ í™•ì¸