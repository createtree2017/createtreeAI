# User Preferences
This file contains preferences for how the agent will work with the user. It can be updated by both the user and the agent.

Preferred communication style: Simple, everyday language.

## 작업 지침
이 섹션에는 에이전트가 따라야 할 특정 작업 지침이 포함됩니다.

### API 경로 및 권한 관리 (2024-05 업데이트)
- 병원 관리자용 API는 항상 `/api/hospital/` 경로로 시작해야 함
- 슈퍼 관리자용 API는 항상 `/api/admin/` 경로로 시작해야 함
- 병원 관리자는 자신의 병원 데이터만 접근 가능하도록 서버측에서 항상 검증 필요
- 권한 검사 실패 시 403 Forbidden 응답 반환 필요
- API 응답에는 항상 적절한 상태 코드 포함 (200, 201, 400, 401, 403, 404, 500)

### 병원 관리자 기능 개발 지침 (2024-05 업데이트)
- 병원 관리자 기능은 `/hospital/` 경로로 접근해야 함
- 병원 ID는 수정 불가능한 필드로 처리 (읽기 전용)
- 수정/삭제 시 항상 소속 병원 검증 후 처리
- 오류 발생 시 사용자 친화적인 메시지 표시
- 권한 문제 발생 시 '접근 권한이 없습니다' 등의 명확한 메시지로 안내

### React-Query 사용 지침 (2024-05 추가)
- **모든 `useQuery`/`useMutation` 호출에서 `queryKey` 와 `queryFn`을 반드시 함께 명시**한다.  
  - `queryFn` 생략 금지 — 생략 시 "Missing queryFn" 경고가 발생함
- 병원(tenant) 리소스를 조회하는 `queryFn` 내부에서는 **URL 또는 Body에 `hospital_id` 를 포함**한다.
- **서버 API** 역시 동일한 `hospital_id` 를 검증해 403 Forbidden을 반환해야 한다.
- 쿼리 오류 시에는 "현재 이미지생성 서비스가 금일 종료 되었습니다" 등 **사용자 친화적 메시지**를 화면에 표시한다.

### 코드 품질 지침 (2024-05 추가)
- TypeScript 강타입 준수: any 타입 사용 지양, 인터페이스/타입 정의 철저
- 컴포넌트 재사용성 극대화: 공통 UI 요소는 컴포넌트화
- 코드 중복 최소화: 유틸리티 함수, 커스텀 훅 적극 활용
- 에러 처리 철저: try/catch 구문 활용, 사용자 친화적 오류 메시지 제공
- 코드 주석: 복잡한 로직이나 비즈니스 규칙에 한글 주석 필수

### 성능 최적화 지침 (2024-05 추가)
- React Query의 `staleTime`, `cacheTime` 설정으로 불필요한 API 호출 최소화
- 대용량 목록은 무한 스크롤 또는 페이징 처리 필수
- 이미지 리소스는 최적화된 포맷(WebP)과 적절한 크기로 제공
- 컴포넌트 렌더링 최적화: React.memo, useCallback, useMemo 적절히 활용
- 불필요한 리렌더링 방지: 상태 관리 최적화, 객체 참조 일관성 유지

### 📦 확장 프로그램 활용 지침 (2025-05 추가)

#### 1. API 테스트 자동화
조건: 새 API가 생성되었거나 기존 API에 변경이 있을 경우
수행: API Request Tester를 통해 해당 API에 테스트 요청을 전송
방식:
- REST: GET, POST, PUT, DELETE 등 메서드 별 테스트
- GraphQL: 쿼리 및 뮤테이션 테스트 포함
결과: 응답 성공 여부 확인 후, 문제 발생 시 콘솔에 경고

#### 2. 응답 구조 및 데이터 확인
조건: API 응답 구조가 복잡하거나 JSON 응답을 검사해야 할 경우
수행: JSON Editor를 통해 응답 데이터 구조를 시각화해 확인
결과: 누락된 필드, 불필요한 중첩 등 구조 개선 여부 판단

#### 3. CSV 데이터 수정이 필요한 경우
조건: 후기 링크, 회원명단, 병원별 캠페인 리스트 등 CSV 파일 기반 관리가 필요한 경우
수행: CSV Editor를 통해 직접 수정 및 확인
결과: 실시간 데이터 가공 및 추출

#### 4. 반복 작업 코드 관리
조건: 후기등록, 배송처리, 이미지 태그 생성 등 자주 사용하는 코드 블록이 있을 경우
수행: SnippetVault를 통해 스니펫 등록 및 재사용
결과: 코드 재사용률 증가, 실수 감소

#### 5. 코드 정리 필요 시
조건: 라플이가 작성한 코드가 포맷이 불일치하거나 리뷰 전일 경우
수행: Prettier를 통해 자동 포맷 적용
조건: npm run format 을 사용하기 전 자동 적용

#### 6. 리소스 사용량 확인
조건: 이미지·영상·음원 등 대용량 파일 사용이 많거나 속도 저하가 발생할 경우
수행: Disk Usage 확장으로 용량 확인
결과: 리소스 최적화 여부 판단

#### 7. DB 백업 및 복구 필요 시
조건: ReplDB 사용 중 데이터 백업 또는 다른 환경으로 이관 필요
수행: ReplDB Export and Import 확장으로 데이터 추출 또는 삽입 수행

#### 8. 스크립트 실행 필요 시
조건: .sh 배포 스크립트, 마이그레이션 명령어 등을 실행해야 할 경우
수행: Run in Shell 을 사용해 자동 실행

#### 9. UI 기획 시각화 필요 시
조건: 캠페인 UI, 후기 입력 팝업 등 시각적 기획이 필요한 경우
수행: UI Sketcher로 빠르게 와이어프레임 제작

#### 10. 다양한 AI 모델 테스트 필요 시
조건: OpenAI 외 다른 모델 성능 비교나 프롬프트 실험을 원할 경우
수행: AI Playground 확장에서 실험 진행

## 코드 스타일 / 품질 가이드라인
- **Lint** : ESLint(airbnb‑typescript) + Prettier 자동 적용  
  - 커밋 전에 `npm run lint && npm run format` 필수
- **타입** : `any` 사용 금지. 필요하면 `unknown` → 좁히기.
- **모듈/파일 규칙**  
  - React 컴포넌트: PascalCase 파일명, 훅: useCamelCase.ts  
  - API 유틸: `/server/services/**`, `/client/lib/api/**`
- **커밋 메시지** : `feat:`, `fix:`, `refactor:`, `chore:` 패턴 유지

## 테스트 & 배포 전략
1. **단위 테스트** (Jest + Testing‑Library)  
   - 훅·유틸 함수는 커버리지 80% 이상
2. **엔드 투 엔드 체크리스트** (매 PR 머지 전)  
   - 로그인 → 캠페인 리스트 → 상세 → 수정 → 로그아웃 흐름
   - 병원 A 관리자가 병원 B 데이터 접근 시 **403** 확인
3. **Replit 워크플로**  
   - `npm run build` 성공 + `npm run test` 통과 시에만 `Redeploy`

## 오류 처리 컨벤션
| 유형 | HTTP Status | 사용자 메시지 | 콘솔/로그 |
|------|------------|---------------|-----------|
| 인증 실패 | 401 | "로그인이 필요합니다." | warn |
| 권한 부족 | 403 | "접근 권한이 없습니다." | warn |
| 리소스 없음 | 404 | "요청하신 정보를 찾을 수 없습니다." | info |
| 서버 예외 | 500 | "잠시 후 다시 시도해주세요." | error |

> **주의** : 서버에서 5xx 발생 시 Sentry(`server/utils/sentry.ts`)로 자동 전송

## UI/UX 원칙
- **모바일 우선** (최소 360 px) → 데스크톱 확장
- **상태 피드백**   
  - 로딩: Skeleton 또는 Spinner  
  - 성공: Toast(성공) 1.5 s  
  - 실패: Toast(오류) + Retry 버튼
- **불변 필드 시각화** : 읽기 전용 input (`readOnly` + bg‑gray‑100)

## 기능 우선순위(2024‑Q2)
1. 병원 캠페인 CRUD 완결 (권한 검증 포함)
2. 관리자 대시보드 통계(병원별 호출량)
3. 이미지 → 스티커 변환 속도 개선
4. 테스트 자동화 ✅

## 라플이 실수 방지 Guardrails
- **API 경로 체크** 헬퍼 `assertApiPrefix(role, path)` 를 서버 미들웨어에 추가해 잘못된 엔드포인트 사용 시 바로 400 반환.
- **queryFn 누락** 검출: 커스텀 ESLint rule `no-missing-queryfn` 추가.
- **hospital_id 빠짐** 방지: 프론트 훅 `useHospitalFetch` 통일 → 파라미터에 자동 삽입.
- **비밀키 노출** 방지: `.replitignore` + Replit Secrets CI 검사.

## 병원 캠페인 기능 확장 지침 (2024-05 추가)

### 1. 캠페인 생성 조건 분기
- 캠페인 생성 시 필수 선택 항목:
  - 신청 방식: `선정형` / `비선정형(선착순)`
  - 후기 제출 여부: `활성` / `비활성`
  - 배송 여부: `배송` / `비배송`
- 각 항목은 UI 조건 및 DB 필드로 분기 처리 필요
- 콘텐츠 등록 기간은 **필수 입력**이며, 없을 시 저장 불가

### 2. 후기 제출 시스템
- 후기 제출 방식: **외부 링크 입력만 허용**
- 입력된 링크는 `reviewUrl` 또는 `reviewUrls` 필드에 저장
- 후기 제출은 콘텐츠 등록 기간 내에만 가능
- 병원관리자도 신청자 리스트 및 후기 제출 리스트 확인 가능
  - 후기 제출 리스트에서 `후기선정 / 취소` 토글 버튼 사용 가능

### 3. 버튼 동작 분기 규칙
- 콘텐츠 등록 **비활성화** 시: 신청 버튼만 노출
- 콘텐츠 등록 **활성화** 시:
  - 캠페인 콘텐츠 등록 기간 동안 `신청 버튼 → 콘텐츠등록 버튼`으로 변경
  - 콘텐츠 등록 버튼은 **선정된 사용자**에게만 노출
  - 클릭 시 입력창 팝업: 링크 다중 입력 가능 (엔터 줄바꿈 기준)

### 4. 권한 분리 원칙
- `슈퍼관리자`, `일반 관리자`:
  - 캠페인 생성/수정/삭제 권한 보유
  - 모든 병원 캠페인 접근 가능
- `병원 관리자`:
  - 소속 병원 캠페인만 **조회 가능 (뷰어 권한)**
  - 신청자 명단 확인 및 후기 리스트 열람 가능
  - 후기선정 버튼은 사용 가능
  - 캠페인 수정, 삭제는 불가능

### 5. 캠페인 종료 조건 정책
- 신청형 캠페인: `신청 종료일` 이후 자동 마감
- 후기형 캠페인: `콘텐츠 등록 종료일` 이후 자동 마감
- 모든 유형에서 관리자(슈퍼/일반/병원)는 마감일 연장 및 강제 마감 가능
- 